import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
from supabase import create_client, Client

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
SUPABASE_URL = "https://snlcbtgzdxsacwjipggn.supabase.co"
SUPABASE_KEY = "sb_publishable_6ZSOF45eZxKKnreEKGgj5Q_sLbpmiLQ"
TELEGRAM_TOKEN = "7948017595:AAFw-ILthgp8F9IopGIqCXlwsqXBRDy4UPY"
OWNER_ID = 7988144062

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

def get_main_menu():
    keyboard = [
        [InlineKeyboardButton("ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø®ØµØµØ©", callback_data="gui_view_cats"), InlineKeyboardButton("ğŸ“… Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©", callback_data="dev")],
        [InlineKeyboardButton("ğŸ›’ Ø³ÙˆÙ‚", callback_data="dev"), InlineKeyboardButton("ğŸ† ØªÙ‡ÙŠØ¦Ø© Ù…Ø³Ø§Ø¨Ù‚Ø©", callback_data="setup_quiz")],
        [InlineKeyboardButton("ğŸ›‘ Ø¥ØºÙ„Ø§Ù‚", callback_data="close_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_text = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ÙŠØ§Ø³Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© @Ya_79k"
    await update.message.reply_text(welcome_text, reply_markup=get_main_menu())

async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user_id = update.effective_user.id
    
    try:
        if data == "gui_view_cats":
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ØªØ¬Ø§ÙˆØ² Ø®Ø·Ø£ Ø§Ù„Ø¹Ù…ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯)
            try:
                res = supabase.table("categories").select("*").execute()
                keyboard = [[InlineKeyboardButton(f"{c['name']}", callback_data=f"manage_cat_{c['id']}")] for c in res.data]
            except:
                keyboard = []
            
            keyboard.append([InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯", callback_data="gui_add_cat")])
            keyboard.append([InlineKeyboardButton("ğŸ”™ Ù„Ù„Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")])
            await query.edit_message_text("Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:", reply_markup=InlineKeyboardMarkup(keyboard))

        elif data.startswith("manage_cat_"):
            cat_id = data.split("_")[2]
            cat_res = supabase.table("categories").select("*").eq("id", cat_id).single().execute()
            keyboard = [
                [InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…", callback_data=f"conf_del_{cat_id}"), InlineKeyboardButton("âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…", callback_data=f"edit_n_{cat_id}")],
                [InlineKeyboardButton("â• Ø³Ø¤Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±", callback_data=f"add_q_{cat_id}"), InlineKeyboardButton("ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", callback_data=f"vq_{cat_id}")],
                [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="gui_view_cats")]
            ]
            await query.edit_message_text(f"Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø³Ù…: {cat_res.data['name']}", reply_markup=InlineKeyboardMarkup(keyboard))

        elif data == "gui_add_cat":
            context.user_data['state'] = 'WAIT_CAT_NAME'
            await query.edit_message_text("ğŸ“ Ø§Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")

        elif data == "back_to_main":
            await query.edit_message_text("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:", reply_markup=get_main_menu())

    except Exception as e:
        logging.error(f"Error in buttons: {e}")
        await query.message.reply_text(f"âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: {e}")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    state = context.user_data.get('state')
    
    if text == "ØªØ­ÙƒÙ…":
        await update.message.reply_text("Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ:", reply_markup=get_main_menu())
        return

    if state == 'WAIT_CAT_NAME':
        # Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙˆØ¯ created_by Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…Ø¤Ù‚ØªØ§Ù‹
        supabase.table("categories").insert({"name": text}).execute()
        context.user_data['state'] = None
        await update.message.reply_text(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… {text} Ø¨Ù†Ø¬Ø§Ø­!")

def main():
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(callback_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    app.run_polling()

if __name__ == "__main__": main()
            
